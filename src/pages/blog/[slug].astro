---
// src/pages/blog/[slug].astro
import Layout from '../../layouts/Layout.astro';
// Importa CollectionEntry y getCollection de astro:content
import { CollectionEntry, getCollection } from 'astro:content';

// --- Debugging Logs Start ---
console.log('--- Start rendering [slug].astro ---'); // <-- ADD 1
// --- Debugging Logs End ---

// 1. Función getStaticPaths para generar cada página estática
export async function getStaticPaths() {
  // --- Debugging Logs Start ---
  console.log('--- Running getStaticPaths ---'); // <-- ADD 2
  // --- Debugging Logs End ---
  // Obtiene todas las entradas de la colección 'blog'
  const posts = await getCollection('blog');
  // --- Debugging Logs Start ---
  console.log(`--- Found ${posts.length} posts for paths ---`); // <-- ADD 3
  // --- Debugging Logs End ---
  // Mapea cada post al formato requerido por Astro
  return posts.map(post => ({
    params: { slug: post.slug }, // Astro genera el slug desde el nombre de archivo
    props: { post },           // Pasa el objeto completo del post como prop
  }));
}

// 2. Obtiene el objeto 'post' actual desde las props, con el tipo correcto
const { post } = Astro.props as { post: CollectionEntry<'blog'> }; // Tipo explícito para seguridad
// --- Debugging Logs Start ---
console.log(`--- Rendering post with slug: ${post.slug} ---`); // <-- ADD 4
// --- Debugging Logs End ---

// 3. Renderiza el contenido Markdown del post a HTML (Moved inside try...catch)

// 4. Extrae las propiedades del frontmatter usando post.data
//    Gracias al esquema en config.ts, Astro valida estos datos
const { title, description, pubDate, author, image } = post.data;
// --- Debugging Logs Start ---
console.log(`--- Post data loaded: Title - ${title} ---`); // <-- ADD 5
console.log(`--- Image data: ${JSON.stringify(image)} ---`); // <-- ADD 6 (Check image object)
// --- Debugging Logs End ---

// --- Try...Catch Block for Rendering ---
let Content; // Declare Content outside the try block
try {
  // --- Debugging Logs Start ---
  console.log('--- Attempting post.render() ---'); // <-- ADD 7
  // --- Debugging Logs End ---
  const rendered = await post.render(); // Renderiza el contenido Markdown
  Content = rendered.Content; // Asigna el componente renderizado
  // --- Debugging Logs Start ---
  console.log('--- post.render() successful ---'); // <-- ADD 8
  // --- Debugging Logs End ---
} catch (renderError) {
  // --- Debugging Logs Start ---
  console.error('--- ERROR during post.render(): ---', renderError); // <-- ADD 9 (Catch render error)
  // --- Debugging Logs End ---
  // Decide cómo manejar el error:
  // Opción 1: Lanzar el error para mostrar un error 500 (lo que está pasando ahora)
  throw renderError;
  // Opción 2: No hacer nada y confiar en el fallback en el HTML
  // Content permanecerá 'undefined'
}
// --- End Try...Catch Block ---
---

{/* Usa el Layout principal, pasando título y descripción específicos */}
<Layout title={`${title} | Blog Pixelarte Studio`} description={description}>
  {/* Contenedor principal del artículo */}
  <article class="bg-claro py-16 md:py-24">
    <div class="container max-w-3xl mx-auto px-4">

      {/* Cabecera del artículo */}
      <header class="mb-10 text-center border-b border-borde-claro pb-6">
        <h1 class="text-4xl md:text-5xl font-playfair font-bold text-oscuro mb-4">
          {title} {/* Muestra el título del post */}
        </h1>
        <p class="text-secundario">
          {/* Muestra el autor y la fecha de publicación formateada */}
          Por {author} | Publicado el {new Date(pubDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
        </p>
      </header>

      {/* Muestra la imagen de portada si está definida y tiene URL */}
      {image && image.url && (
        <img
          src={image.url}
          alt={image.alt || ''}
          class="rounded-lg mb-10 w-full aspect-video object-cover shadow-md"
          width="800"
          height="450"
          loading="lazy" /* Mejora rendimiento */
          decoding="async" /* Mejora rendimiento */
        />
      )}

      {/* Renderiza el contenido principal del archivo Markdown */}
      <div class="prose max-w-none">
        {/* Verifica si Content existe antes de intentar renderizarlo */}
        {Content ? <Content /> : <p class="text-red-600 font-bold">Error: No se pudo renderizar el contenido del post.</p>} {/* Fallback si Content falló */}
      </div>

       {/* Enlace para volver al índice del blog */}
       <div class="text-center mt-10 pt-6 border-t border-borde-claro">
          <a href="/blog/" class="btn-primary">&larr; Volver al Blog</a>
       </div>

    </div>
  </article>
</Layout>

{/* Estilos globales para dar formato al contenido HTML generado desde Markdown */}
<style is:global>
  .prose {
    font-size: 1.125rem; /* ~18px */
    line-height: 1.8;
    color: var(--color-texto-secundario);
  }
  .prose h2 {
    font-size: 1.875rem; /* ~30px */
    color: var(--color-texto-oscuro);
    margin-top: 2.5em;
    margin-bottom: 1em;
    font-family: 'Playfair Display', serif;
    padding-bottom: 0.3em;
    border-bottom: 1px solid var(--color-borde-claro);
  }
  .prose h3 {
    font-size: 1.5rem; /* ~24px */
    color: var(--color-texto-oscuro);
    margin-top: 2em;
    margin-bottom: 1em;
     font-family: 'Playfair Display', serif;
  }
  .prose p {
    margin-bottom: 1.25em;
  }
  .prose a {
    color: var(--color-acento);
    text-decoration: underline;
    transition: color 0.2s ease;
  }
  .prose a:hover {
    color: #1D4ED8; /* Azul más oscuro al pasar el ratón */
  }
  .prose strong {
    font-weight: 700;
    color: var(--color-texto-oscuro);
  }
  .prose ul, .prose ol {
    margin-left: 1.5em;
    margin-bottom: 1.25em;
    padding-left: 1em;
  }
  .prose li {
    margin-bottom: 0.5em;
  }
  .prose li > p {
      margin-bottom: 0.5em;
  }
  .prose blockquote {
    border-left: 4px solid var(--color-acento);
    padding-left: 1em;
    margin-left: 0;
    margin-right: 0;
    font-style: italic;
    color: var(--color-texto-secundario);
    background-color: #f9fafb;
    padding-top: 0.5em;
    padding-bottom: 0.5em;
  }
  .prose img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      margin-top: 2em;
      margin-bottom: 2em;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Sombra sutil */
  }
   .prose code {
    background-color: #e5e7eb; /* Gris claro */
    color: var(--color-texto-oscuro);
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.9em;
    font-family: monospace; /* Fuente monoespaciada */
  }
  .prose pre {
    background-color: var(--color-oscuro-contraste); /* Fondo oscuro */
    color: var(--color-texto-claro); /* Texto claro */
    padding: 1em;
    border-radius: 0.5rem;
    overflow-x: auto; /* Scroll horizontal si es necesario */
    font-family: monospace;
  }
  .prose pre code { /* Estilo específico para código dentro de <pre> */
      background-color: transparent;
      color: inherit;
      padding: 0;
      font-size: inherit;
  }
  /* Estilo para el mensaje de error de renderizado */
  .text-red-600 { color: #dc2626; }
  .font-bold { font-weight: 700; }
</style>