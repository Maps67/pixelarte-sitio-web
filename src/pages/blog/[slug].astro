---
// src/pages/blog/[slug].astro
import Layout from '../../layouts/Layout.astro';
import { CollectionEntry, getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: CollectionEntry<'blog'> };

// --- Si 'post' es undefined, astro 404 ---
if (!post) {
  return Astro.redirect('/404/');
}

const { Content } = await post.render();
const { title, description, pubDate, author, image } = post.data;

// ===== INICIO DEL CAMBIO: Definir URL de OG Image =====
const ogImageUrl = `/api/og/${post.slug}.png`;
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;
// ===== FIN DEL CAMBIO =====
---

{/* Pasamos los nuevos meta-tags al Layout.
  Usamos la imagen de portada (image.url) como fallback 
  si la imagen din√°mica falla.
*/}
<Layout 
  title={`${title} | Blog Pixelarte Studio`} 
  description={description}
  ogImage={ogImageUrl} 
  ogImageAlt={title}
  canonicalUrl={canonicalUrl}
>
  <article class="bg-claro py-16 md:py-24">
    <div class="container max-w-3xl mx-auto px-4">
      
      <header class="mb-10 text-center border-b border-borde-claro pb-6">
        <h1 class="text-4xl md:text-5xl font-playfair font-bold text-oscuro mb-4">
          {title}
        </h1>
        <p class="text-secundario">
          Por {author} | Publicado el {new Date(pubDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
        </p>
      </header>

      {image && image.url && (
        <img 
          src={image.url} 
          alt={image.alt || ''} 
          class="rounded-lg mb-10 w-full aspect-video object-cover shadow-md" 
          width="800" 
          height="450"
          loading="lazy"
          decoding="async"
        />
      )}

      <div class="prose max-w-none">
        <Content /> 
      </div>

       <div class="text-center mt-10 pt-6 border-t border-borde-claro">
          <a href="/blog/" class="btn-primary">&larr; Volver al Blog</a>
       </div>

    </div>
  </article>
</Layout>

<style is:global>
  /* ... (Tus estilos .prose no cambian) ... */
</style>